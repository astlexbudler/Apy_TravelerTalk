<div class="modal fade" id="addAccount" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black-60">
                    사용자 생성
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- name -->
                <div class="row mb-4">
                    <div class="form-group col-6">
                        <label>아이디</label> <small id="accountIdConfirmText"></small>
                        <input class="form-control" placeholder="아이디를 입력해주세요." id="accountId">
                    </div>
                    <div class="form-group col-6">
                        <label>닉네임</label> <small id="accountNicknameConfirmText"></small>
                        <input class="form-control" placeholder="닉네임을 입력해주세요." id="accountNickname">
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label>비밀번호</label> <small id="accountPasswordConfirmText"></small>
                    <input type="password" class="form-control" placeholder="비밀번호를 입력해주세요." id="accountPassword">
                </div>

                <div class="form-group mb-4">
                    <label>비밀번호 확인</label> <small id="accountPasswordCheckConfirmText"></small>
                    <input type="password" class="form-control" placeholder="비밀번호를 다시 입력해주세요."
                        id="accountPasswordConfirm">
                </div>

                <div class="row mb-4">
                    <div class="form-group col-4">
                        <label>다중 생성</label>
                        <input type="number" class="form-control" placeholder="다중 생성할 사용자 수를 입력해주세요."
                            id="accountCount">
                    </div>
                    <div class="form-group col-8">
                        <label>계정 종류</label>
                        <select class="form-select" id="accountType" onchange="changeAccountType(this.value)">
                            <option value="user">사용자</option>
                            <option value="dame">여성회원</option>
                            <option value="partner">파트너</option>
                        </select>
                    </div>
                </div>

                <!-- 게시글 및 카테고리 정보 -->
                <div class="d-none" id="partnerInfo">
                    <div class="row mb-4">
                        <div class="form-group col-6">
                            <label>게시판</label>
                            <select class="form-select" id="selectedBoard">
                                <option value="">전체</option>
                                {% for board in travel_boards %}
                                <option value="{{ board.id }}" {% if board.id == request.GET.board_id %}selected{% endif %}>{{ board.name }}</option>
                                {% if board.children|length > 0 %}
                                {% for child in board.children %}
                                <option value="{{ child.id }}" {% if child.id == request.GET.board_id %}selected{% endif %}>- {{ child.name }}</option>
                                {% if child.children|length > 0 %}
                                {% for grandchild in child.children %}
                                <option value="{{ grandchild.id }}" {% if grandchild.id == request.GET.board_id %}selected{% endif %}>
                                -- {{ grandchild.name }}</option>
                                {% if grandchild.children|length > 0 %}
                                {% for grandgrandchild in grandchild.children %}
                                <option value="{{ grandgrandchild.id }}" {% if grandgrandchild.id == request.GET.board_id %}selected{% endif %}>--- {{ grandgrandchild.name }}</option>
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-6">
                        <label>카테고리</label>
                            <select class="form-select" id="serviceCategory">
                                <option value="">전체</option>
                                {% for board in categories %}
                                <option value="{{ board.id }}" {% if board.id == request.GET.board_id %}selected{% endif %}>{{ board.name }}</option>
                                {% if board.children|length > 0 %}
                                {% for child in board.children %}
                                <option value="{{ child.id }}" {% if child.id == request.GET.board_id %}selected{% endif %}>- {{ child.name }}</option>
                                {% if child.children|length > 0 %}
                                {% for grandchild in child.children %}
                                <option value="{{ grandchild.id }}" {% if grandchild.id == request.GET.board_id %}selected{% endif %}>
                                -- {{ grandchild.name }}</option>
                                {% if grandchild.children|length > 0 %}
                                {% for grandgrandchild in grandchild.children %}
                                <option value="{{ grandgrandchild.id }}" {% if grandgrandchild.id == request.GET.board_id %}selected{% endif %}>--- {{ grandgrandchild.name }}</option>
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary me-2" onclick="addNewAccount()">
                    <i class="fi fi-rr-user-add"></i> 사용자 추가
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    취소
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    var accountIdConfirmText = document.getElementById('accountIdConfirmText');
    var accountId = document.getElementById('accountId')
    var accountPassword = document.getElementById('accountPassword');
    var accountPasswordConfirmText = document.getElementById('accountPasswordConfirmText');
    var accountPasswordConfirm = document.getElementById('accountPasswordConfirm');
    var accountPasswordCheckConfirmText = document.getElementById('accountPasswordCheckConfirmText');
    var accountIdOk = false;
    var accountPasswordOk = false;
    var accountPasswordConfirmOk = false;

    // 계정 종류에 따른 추가 정보 입력
    changeAccountType = (selected) => {
        if (selected === 'partner') {
            document.getElementById('partnerInfo').classList.remove('d-none');
        } else {
            document.getElementById('partnerInfo').classList.add('d-none');
        }
    }

    // 하위 관리자 아이디 확인
    document.getElementById('accountId').addEventListener('input', async () => {
        if (accountId.value.length < 4) {
            accountIdConfirmText.innerText = '아이디는 4자 이상이어야 합니다.';
            accountIdOk = false;
            return
        }

        // 중복검사
        var accounts = await fetch(`/api/account?id=${accountId.value}`)
            .then(res => res.json())
            .then(data => {
                console.log(data);
                return data.data;
            });

        // 중복검사 결과에 따른 메시지 출력
        if (accounts.length == 0) {
            accountIdConfirmText.innerText = '사용 가능한 아이디입니다.';
            accountIdConfirmText.classList.add('text-success');
            accountIdConfirmText.classList.remove('text-danger');
            accountIdOk = true; // 아이디 중복검사 통과. 사용 가능
        }
        if (accounts[0]['username'] == accountId) {
            accountIdConfirmText.innerText = '이미 사용중인 아이디입니다.';
            accountIdConfirmText.classList.remove('text-success');
            accountIdConfirmText.classList.add('text-danger');
            accountIdOk = false; // 아이디 중복검사 실패. 사용 불가
            return
        }
        accountIdConfirmText.innerText = '사용 가능한 아이디입니다.';
        accountIdConfirmText.classList.add('text-success');
        accountIdConfirmText.classList.remove('text-danger');
        accountIdOk = true; // 아이디 중복검사 통과. 사용 가능
    });

    // 하위 관리자 비밀번호 확인
    document.getElementById('accountPassword').addEventListener('input', () => {

        // 비밀번호 형식 확인에 따른 메시지 출력
        if (!passwordRegex.test(accountPassword.value)) {
            accountPasswordConfirmText.innerText = '비밀번호는 5자 이상, 영문, 숫자 포함해야 합니다.';
            accountPasswordConfirmText.classList.remove('text-success');
            accountPasswordConfirmText.classList.add('text-danger');
            accountPasswordOk = false; // 비밀번호 형식 불일치. 사용 불가
            return
        }
        accountPasswordConfirmText.innerText = '사용 가능한 비밀번호입니다.';
        accountPasswordConfirmText.classList.add('text-success');
        accountPasswordConfirmText.classList.remove('text-danger');
        accountPasswordOk = true; // 비밀번호 형식 일치. 사용 가능
    });
    document.getElementById('accountPasswordConfirm').addEventListener('input', () => {

        // 비밀번호 확인 일치 여부 확인에 따른 메시지 출력
        if (accountPassword.value !== accountPasswordConfirm.value) {
            accountPasswordCheckConfirmText.innerText = '비밀번호가 일치하지 않습니다.';
            accountPasswordCheckConfirmText.classList.remove('text-success');
            accountPasswordCheckConfirmText.classList.add('text-danger');
            accountPasswordConfirmOk = false;
            return;
        }
        accountPasswordCheckConfirmText.innerText = '비밀번호가 일치합니다.';
        accountPasswordCheckConfirmText.classList.add('text-success');
        accountPasswordCheckConfirmText.classList.remove('text-danger');
        accountPasswordConfirmOk = true;
    });

    // 닉네임 중복 검사
    checkNickname = async (nickname) => {
        return await fetch(`/api/account?nickname=${nickname}`)
            .then(res => res.json())
            .then(data => {
                console.log(data);
                return data.data;
            });
    }

    document.querySelector('#accountNickname').addEventListener('input', async () => {
        var name = document.getElementById('accountNickname').value;
        var nameConfirmText = document.getElementById('accountNicknameConfirmText');

        // 닉네임 길이 확인
        if (name.length < 2) {
            nameConfirmText.innerText = '닉네임은 2자 이상이어야 합니다.';
            nameConfirmText.classList.remove('text-success');
            nameConfirmText.classList.add('text-danger');
            return
        }

        // 닉네임 중복 검사
        var accounts = await checkNickname(name);

        // 닉네임 중복 검사 결과에 따른 메시지 출력
        if (accounts.length == 0) {
            nameConfirmText.innerText = '사용 가능한 닉네임입니다.';
            nameConfirmText.classList.add('text-success');
            nameConfirmText.classList.remove('text-danger');
            return
        }
        if (accounts[0]['nickname'] === name) {
            nameConfirmText.innerText = '이미 사용중인 닉네임입니다.';
            nameConfirmText.classList.remove('text-success');
            nameConfirmText.classList.add('text-danger');
            return
        }
        nameConfirmText.innerText = '사용 가능한 닉네임입니다.';
        nameConfirmText.classList.add('text-success');
        nameConfirmText.classList.remove('text-danger');
    });

    // 하위 관리자 추가
    addNewAccount = async () => {

        showAlert('계정 생성', '계정을 생성중입니다. 완료될 때까지 기다려주세요.', 'info');

        // 다중 생성
        for (var i = 0; i < document.getElementById('accountCount').value; i++) {
            var formData = new FormData();
            formData.append('id', document.getElementById('accountId').value + i);
            formData.append('password', document.getElementById('accountPassword').value);
            formData.append('nickname', document.getElementById('accountNickname').value + i);
            formData.append('account_type', document.getElementById('accountType').value);
            if (document.getElementById('accountType').value === 'partner') {
                formData.append('partner_name', 'partner');
                formData.append('email', 'partner@email.com');
                formData.append('phone', '010-1234-5678');
                formData.append('board_ids', document.getElementById('selectedBoard').value);
                formData.append('category_ids', document.getElementById('serviceCategory').value);
            }

            if (!accountIdOk || !accountPasswordOk || !accountPasswordConfirmOk) {
                showAlert('정보 확인', '아이디 및 비밀번호를 확인해주세요.', 'error');
                return
            }

            // 하위 관리자 추가
            await fetch('/api/account', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
        }
        await showAlert('계정 생성', '계정이 생성되었습니다.', 'success');
        location.reload();
    }

</script>