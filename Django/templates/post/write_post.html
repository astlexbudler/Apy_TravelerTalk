{% extends 'base/base.html' %}
{% block content %}
<main class="container">

  <div class="main-section">

    <div style="min-height: calc(100vh - 160px);">

      <!-- 페이지 타이틀 -->
      {% include 'components/main/breadcrumbs.html' %}
      {% with subtitle=board.name %}
      {% include 'components/main/title_section.html' with title='게시글 작성' %}
      {% endwith %}

      <!-- 게시글 작성 폼 -->
      <div class="mt-4">

        <!-- 대표 이미지 -->
        {% if request.GET.board_ids != '38' %}
        <div class="my-4">
          {% include 'components/other/upload_image.html' with label='썸네일 이미지' id='imageInput' %}
        </div>
        {% else %}
        <input type="file" class="d-none" id="imageInput" multiple name="image">
        {% endif %}


        <!-- 제목 -->
        <div class="my-4">
          <div class="form-group">
            <label>제목</label>
            <input class="form-control" id="title" placeholder="제목을 입력해 주세요.">
          </div>
        </div>

        <!-- 쿠폰 등록 -->
        {% if request.GET.board_ids == '34,36' %}
        <div class="my-4">
          <div class="form-group">
            <label>쿠폰 등록</label> <small id="couponConfirmMessage"></small>
            <input class="form-control" id="couponName" placeholder="쿠폰 이름을 입력해주세요." oninput="checkCoupon(this.value)">
            <div class="alert alert-info small mt-2">
              <i class="fi fi-rr-info"></i> 같은 이름의 쿠폰이 여러개인 경우, 같은 이름의 모든 쿠폰이 등록됩니다.
            </div>
          </div>
        </div>
        {% endif %}

        <!-- wysiwig 에디터 -->
        <div class="my-4">
          <div class="form-group">
            <label>내용 편집기</label>
            {% include 'components/main/editor.html' with id='content' height='500' %}
          </div>
        </div>

        <!-- 작성하기 -->
        <div class="my-5 text-end">
          <a class="btn btn-primary" href="javascript: writePost()">
            <i class="fi fi-rr-edit"></i> 글 작성
          </a>
        </div>

      </div>

    </div>

  </div>

</main>
<script>

  // 쿠폰 확인
  const couponConfirmMessage = document.getElementById('couponConfirmMessage');
  var couponValid = false;
  checkCoupon = async (couponName) => {
    if (couponName.length < 2) {
      couponConfirmMessage.classList.add('text-danger');
      couponConfirmMessage.classList.remove('text-success');
      couponConfirmMessage.innerHTML = '쿠폰 이름을 2글자 이상 입력해주세요.';
      couponValid = false;
      return;
    }

    // 쿠폰 검색
    var data = await fetch(`/api/coupon?name=${couponName}`)
    .then(res => res.json())
    .then(data => {
        console.log(data);
        return data.data;
    });

    // 쿠폰 검색 결과 확인
    if(data.length == 0) {
        couponConfirmMessage.innerHTML = '존재하지 않는 쿠폰 이름입니다.';
        couponConfirmMessage.classList.add('text-danger');
        couponConfirmMessage.classList.remove('text-success');
        couponValid = false;
        return;
    }
    if (data[0]['name'] == couponName && '{{account.id}}' == data[0]['create_account']['id']) {
        couponConfirmMessage.innerHTML = '유효한 쿠폰 이름입니다.';
        couponConfirmMessage.classList.add('text-success');
        couponConfirmMessage.classList.remove('text-danger');
        couponValid = true;
        return;
    }
    couponConfirmMessage.innerHTML = '존재하지 않는 쿠폰 이름입니다.';
    couponConfirmMessage.classList.add('text-danger');
    couponConfirmMessage.classList.remove('text-success');
    couponValid = false;
  }

  // 대표 이미지 추가
  document.getElementById('imageInput').addEventListener('change', async (e) => {
    const files = e.target.files;

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const reader = new FileReader();
      reader.onload = (e) => {
        const imagePath = e.target.result;
        document.getElementById('imagePreview').innerHTML = `
        <div class="mb-2 me-2 shadow-sm text-end p-2" style="min-width: 150px; width: 12vw; background: url('${imagePath}') center/cover no-repeat; display: inline-block; min-height: 150px; height: 12vw;"></div>
        `;
      }
      reader.readAsDataURL(file);
    }
  });

  // 게시글 작성
  writePost = async () => {
    const title = document.querySelector('#title').value;
    const content = $('#content').summernote('code');

    if (title.length < 2) {
      showAlert('제목 오류', '제목이 너무 짧습니다. 2자 이상 작성해주세요.', 'error');
      return;
    }
    if (content.length < 10) {
      showAlert('내용 오류', '내용이 너무 짧습니다. 10자 이상 입력해주세요.', 'error');
      return;
    }

    var formData = new FormData();
    formData.append('title', title);
    formData.append('content', content);
    formData.append('review_post_id', '{{ request.GET.review_post_id }}');
    if (document.getElementById('imageInput')) {
      formData.append('image', document.getElementById('imageInput').files[0]); // 대표 이미지
    }
    if (couponValid) {
      formData.append('coupon_name', document.getElementById('couponName').value);
    }

    await fetch('/post/write_post?board_ids={{request.GET.board_ids}}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      },
      body: formData,
    })
      .then(response => response.json())
      .then(async (data) => {
        if (data.result == 'success') {
          await showAlert('게시글 작성 완료', '게시글이 성공적으로 작성되었습니다.', 'success');
          window.location.href = '/post/post_view?post_id=' + data.post_id + '&board_ids={{request.GET.board_ids}}';
        } else {
          showAlert('게시글 작성 실패', '게시글 작성에 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');
        }
      });
  }

</script>

{% endblock %}