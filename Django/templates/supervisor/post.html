{% extends 'base/base_supervisor.html' %}
{% block content %}
<main class="container">

  <div class="main-section">

    <!-- 페이지 타이틀 -->
    {% with title='게시글 관리' subtitle='일반 게시글 관리' %}
    {% include 'components/main/title_section.html' %}
    {% endwith %}

    <!-- 게시글 -->
    <div class="my-5" id="user">

      <!-- 버튼 -->
      <div class="p-3 mb-5 text-end">

        <a class="btn btn-success btn-sm me-2"
          href="javascript: new bootstrap.Modal(document.getElementById('addnewBoardModal')).show()">
          <i class="fi fi-rr-plus"></i> 최상위 게시판 추가
        </a>

      </div>

      <!-- 통계 -->
      <div class="rounded border p-3 mb-5 shadow">
        <p>
          <i class="fi fi-rr-stats"></i> 게시판 편집
        </p>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>구분</th>
              <th>조회수</th>
              <th>게시글 수</th>
              <th style="width: 100px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for board in status %}
            <tr>
              <td>
                <p>
                  {{ board.name }}<br>

                  <!-- 하위 게시판 추가. 트리 타입만 가능 -->
                  {% if board.board_type == 'tree' %}
                  <a href="javascript: document.getElementById('subBoardParent').value = '{{ board.id }}'; new bootstrap.Modal(document.getElementById('addnewBoardModal')).show()"
                    class="btn btn-success p-1 px-2 small">
                    <i class="fi fi-rr-plus"></i> 하위 게시판 추가
                  </a>
                  {% endif %}

                </p>
              </td>
              <td>{{ board.total_views }}</td>
              <td>{{ board.total_posts }}</td>
              <td class="text-center">

                <!-- 게시판 수정 -->
                <a href="javascript: new bootstrap.Modal(document.getElementById('{{ board.id }}EditModal')).show()">
                  <i class="fi fi-rr-edit"></i>
                </a>
                {% with to_modify_board=board %}
                {% include 'components/modal/supervisor/update_board.html' %}
                {% endwith %}

              </td>
            </tr>
            {% if board.children|length > 0 %}
            {% for child in board.children %}
            <tr>
              <td>
                <p class="ms-2">
                  {{ child.name }}<br>

                  <!-- 하위 게시판 추가. 트리 타입만 가능 -->
                  {% if child.board_type == 'tree' %}
                  <a href="javascript: document.getElementById('subBoardParent').value = '{{ board.id }}'; new bootstrap.Modal(document.getElementById('addnewBoardModal')).show()"
                    class="btn btn-success p-1 px-2 small">
                    <i class="fi fi-rr-plus"></i> 하위 게시판 추가
                  </a>
                  {% endif %}

                </p>
              </td>
              <td>{{ child.total_views }}</td>
              <td>{{ child.total_posts }}</td>
              <td class="text-center">

                <!-- 게시판 수정 -->
                <a href="javascript: new bootstrap.Modal(document.getElementById('{{ child.id }}EditModal')).show()">
                  <i class="fi fi-rr-edit"></i>
                </a>
                {% with to_modify_board=child %}
                {% include 'components/modal/supervisor/update_board.html' %}
                {% endwith %}

              </td>
              {% if child.children|length > 0 %}
              {% for grandchild in child.children %}
            <tr>
              <td>
                <p class="ms-4">
                  {{ grandchild.name }}<br>

                  <!-- 하위 게시판 추가. 트리 타입만 가능 -->
                  {% if grandchild.board_type == 'tree' %}
                  <a href="javascript: document.getElementById('subBoardParent').value = '{{ board.id }}'; new bootstrap.Modal(document.getElementById('addnewBoardModal')).show()"
                    class="btn btn-success p-1 px-2 small">
                    <i class="fi fi-rr-plus"></i> 하위 게시판 추가
                  </a>
                  {% endif %}

                </p>
              </td>
              <td>{{ grandchild.total_views }}</td>
              <td>{{ grandchild.total_posts }}</td>
              <td class="text-center">

                <!-- 게시판 수정 -->
                <a
                  href="javascript: new bootstrap.Modal(document.getElementById('{{ grandchild.id }}EditModal')).show()">
                  <i class="fi fi-rr-edit"></i>
                </a>
                {% with to_modify_board=grandchild %}
                {% include 'components/modal/supervisor/update_board.html' %}
                {% endwith %}

              </td>
            </tr>
            {% if grandchild.children|length > 0 %}
            {% for grandgrandchild in grandchild.children %}
            <tr>
              <td>
                <span class="ms-6">{{ grandgrandchild.name }}</span>
              </td>
              <td>{{ grandgrandchild.total_views }}</td>
              <td>{{ grandgrandchild.total_posts }}</td>
              <td class="text-center">

                <!-- 게시판 수정 -->
                <a
                  href="javascript: new bootstrap.Modal(document.getElementById('{{ grandgrandchild.id }}EditModal')).show()">
                  <i class="fi fi-rr-edit"></i>
                </a>
                {% with to_modify_board=grandgrandchild %}
                {% include 'components/modal/supervisor/update_board.html' %}
                {% endwith %}

              </td>
            </tr>
            {% endfor %}
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endfor %}
          </tbody>
        </table>

      </div>

      <!-- 검색 -->
      <div class="rounded border p-3 mb-5 shadow">
        <p>
          <i class="fi fi-rr-search"></i> 검색
        </p>
        <form method="get" action="{{supervisor_url}}/supervisor/post">
          <div class="form-group mt-4 col-12">
            <label>제목</label>
            <input class="form-control" name="post_title" placeholder="게시글 제목" value="{{request.GET.post_title}}">
          </div>
          <div class="row my-4">
            <div class="form-group col-6">
              <label>게시판</label>
              <select class="form-select" name="board_id">
                <option value="">전체</option>
                {% for board in status %}
                <option value="{{ board.id }}" {% if board.id == request.GET.board_id %}selected{% endif %}>{{ board.name }}</option>
                {% if board.children|length > 0 %}
                {% for child in board.children %}
                <option value="{{ child.id }}" {% if child.id == request.GET.board_id %}selected{% endif %}>- {{ child.name }}</option>
                {% if child.children|length > 0 %}
                {% for grandchild in child.children %}
                <option value="{{ grandchild.id }}" {% if grandchild.id == request.GET.board_id %}selected{% endif %}>-- {{ grandchild.name }}</option>
                {% if grandchild.children|length > 0 %}
                {% for grandgrandchild in grandchild.children %}
                <option value="{{ grandgrandchild.id }}" {% if grandgrandchild.id == request.GET.board_id %}selected{% endif %}>--- {{ grandgrandchild.name }}</option>
                {% endfor %}
                {% endif %}
                {% endfor %}
                {% endif %}
                {% endfor %}
                {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="form-group col-6">
              <label>작성자 아이디 또는 닉네임</label>
              <input class="form-control" name="author_id" placeholder="작성자 아이디 또는 닉네임" value="{{request.GET.author_id}}">
            </div>
          </div>
          <p class="text-end pt-5">
            <button class="btn btn-primary" type="submit">
              <i class="fi fi-rr-search"></i> 검색
            </button>
          </p>
        </form>
      </div>

      <!-- 버튼 -->
      <div class="p-3 mb-5 text-end">

        <a href="javascript: openExportDataPage();" class="btn btn-sm btn-success">
          <i class="fi fi-rr-file-excel"></i> 다운로드
        </a>

      </div>

      <!-- 검색 결과 -->
      {% if posts|length == 0 %}
      <p>
        게시글이 없습니다.
      </p>
      {% endif %}

      {% for post in posts %}
      <a class="text-dark text-decoration-none" href="{{supervisor_url}}/supervisor/post/edit?post_id={{post.id}}">
        <div style="display: flex; white-space: nowrap;" class="mb-3 pb-3 border-bottom">
          <div style="display: inline-block; text-align: left;">
            {% if post.image %}
            <img src="{{post.image}}" class="img-fluid rounded img-web shadow m-1" style="width: 6vw; min-width: 80px; max-width: 100px;">
            {% endif %}
          </div>
          <div style="display: inline-block; text-align: left; flex: 1;">
            <div style="display: flex; justify-content: space-between; white-space: nowrap;">
              <div style="display: inline-block; text-align: left;">
                <div class="ps-3">
                  <p class="text-black-50 small mb-1">
                    <span class="me-1">
                      {{post.author.nickname}}
                    </span>
                    {% include 'components/other/level_badge.html' with level=post.author.level %}
                  </p>
                  <p>
                    {{post.title}}
                  </p>
                  <p class="text-black-50 small m-0">
                    {{post.created_at}}
                  </p>
                </div>
              </div>
              <div style="display: inline-block; text-align: right;">
                <p class="m-0 text-end text-black-50" style="font-size: 12px;">
                  <span class="me-1" style="white-space: nowrap;">
                    <i class="fi fi-rr-eye"></i> {{post.view_count}}
                  </span>
                  <span class="me-1" style="white-space: nowrap;">
                    <i class="fi fi-rr-social-network"></i> {{post.like_count}}
                  </span>
                  <span style="white-space: nowrap;">
                    <i class="fi fi-rr-comment-dots"></i> {{post.comment_count}}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </a>

      {% endfor %}

      <!--
        <div class="col-12 col-md-6 col-lg-4 p-2 mb-2 pb-3 w-100">
          <a href="{{main_url}}/post/post_view?post_id={{ post.id }}" class="text-dark text-decoration-none">
            <div class="col-12 p-2 mb-2 pb-3 border-bottom">
              <p class="mt-2">
                {{post.board.name}}
              </p>
              <div class="row g-0">
                {% if post.image and post.image != '/media/default.png' %}
                <div class="col-2 col-md-2">
                  <img src="{{ post.image }}" class="img-fluid rounded-start img-web shadow" />
                </div>
                {% endif %}
                <div
                  class="{% if post.image and post.image != '/media/default.png' %}col-10 col-md-10 ps-3{% else %}col-12 col-md-12{% endif %}">
                  <div class="p-3 px-0">
                    <div>
                      <span class="text-black-50" style="font-size: 12px;">
                        {% for board in post.boards %}
                        {{ board.name }} {% if forloop.counter < post.boards|length %} &gt; {% endif %} {% endfor %}
                          </span>
                    </div>
                    <div class="d-flex">
                      <div class="d-flex w-100">
                        <h6 class="mb-2">
                          {{ post.title }}
                        </h6>
                      </div>
                      <div class="d-flex w-100 justify-content-end">
                        <p class="m-0 text-end text-black-50" style="font-size: 12px;">
                          <span class="me-1" style="white-space: nowrap;">
                            <i class="fi fi-rr-eye"></i> {{ post.view_count }}
                          </span>
                          <span class="me-1" style="white-space: nowrap;">
                            <i class="fi fi-rr-social-network"></i> {{ post.like_count }}
                          </span>
                        </p>
                      </div>
                    </div>
                    <div>
                      {% if board.board_type != 'anonymous' %}
                      <span class="text-black-50">

                        {% if post.author.partner_name != '' %}
                        <i class="fi fi-rr-heart"></i> {{ post.author.partner_name }}

                        {% else %}
                        <i class="fi fi-rr-user"></i> {{ post.author.nickname }}

                        {% if account.account_type == 'user' or account.account_type == 'dame' %}

                        {% with level=profile.level %}
                        {% include 'parts/level_badge.html' %}
                        {% endwith %}

                        {% endif %}

                        {% endif %}

                      </span>
                      {% endif %}
                    </div>
                    <div>
                      <small class="text-black-50 mt-1">
                        <i class="fi fi-rr-calendar"></i> {{ post.created_at }}
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </a>
        </div>-->

      <!-- 페이지네이션 영역 -->
      {% include 'components/main/pagination.html' %}

    </div>

    <!-- 맨 위로 가기 버튼 -->
    <div class="text-end mb-5">
      {% include 'components/main/top_button.html' %}
    </div>

  </div>

</main>

<!-- Modal -->
<!-- 게시판 추가 모달 -->
{% include 'components/modal/supervisor/create_board.html' %}

<script>

  window.addEventListener('DOMContentLoaded', (event) => {

    // Page
    var searchPostTItle = '{{request.GET.postTitle}}';
    var searchPostBoard = '{{request.GET.postBoard}}';
    console.log('{{request.GET.page}} | {{last_page}}');
    makePaegeButton('{{request.GET.page}}', '{{last_page}}', `{{supervisor_url}}/supervisor/post?post_title=${searchPostTItle}&board_id=${searchPostBoard}`);

  });

  // 토글
  toggleAll = (name, checked) => {
    var checkboxes = document.querySelectorAll(`input[id^='${name}']`);
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = checked;
    }
  }


  // 게시판 정보 수정
  updateBoard = async (board_id) => {
    var boardName = document.getElementById(board_id + 'Name').value;
    var boardType = document.getElementById(board_id + 'Type').value;
    var boardLevel = document.getElementById(board_id + 'Level').value;
    var boardWeight = document.getElementById(board_id + 'Weight').value;
    var boardDisplayGuest = document.getElementById(board_id + 'DisplayGuest').checked;
    var boardDisplayUser = document.getElementById(board_id + 'DisplayUser').checked;
    var boardDisplayDame = document.getElementById(board_id + 'DisplayDame').checked;
    var boardDisplayPartner = document.getElementById(board_id + 'DisplayPartner').checked;
    var boardDisplaySubsupervisor = document.getElementById(board_id + 'DisplaySubsupervisor').checked;
    var boardDisplaySupervisor = document.getElementById(board_id + 'DisplaySupervisor').checked;
    var boardEnterGuest = document.getElementById(board_id + 'EnterGuest').checked;
    var boardEnterUser = document.getElementById(board_id + 'EnterUser').checked;
    var boardEnterDame = document.getElementById(board_id + 'EnterDame').checked;
    var boardEnterPartner = document.getElementById(board_id + 'EnterPartner').checked;
    var boardEnterSubsupervisor = document.getElementById(board_id + 'EnterSubsupervisor').checked;
    var boardEnterSupervisor = document.getElementById(board_id + 'EnterSupervisor').checked;
    var boardWriteUser = document.getElementById(board_id + 'WriteUser').checked;
    var boardWriteDame = document.getElementById(board_id + 'WriteDame').checked;
    var boardWritePartner = document.getElementById(board_id + 'WritePartner').checked;
    var boardWriteSubsupervisor = document.getElementById(board_id + 'WriteSubsupervisor').checked;
    var boardWriteSupervisor = document.getElementById(board_id + 'WriteSupervisor').checked;
    var boardCommentUser = document.getElementById(board_id + 'CommentUser').checked;
    var boardCommentDame = document.getElementById(board_id + 'CommentDame').checked;
    var boardCommentPartner = document.getElementById(board_id + 'CommentPartner').checked;
    var boardCommentSubsupervisor = document.getElementById(board_id + 'CommentSubsupervisor').checked;
    var boardCommentSupervisor = document.getElementById(board_id + 'CommentSupervisor').checked;

    var displayGroups = `${boardDisplayGuest ? 'guest' : ''},${boardDisplayUser ? 'user' : ''},${boardDisplayDame ? 'dame' : ''},${boardDisplayPartner ? 'partner' : ''},${boardDisplaySubsupervisor ? 'subsupervisor' : ''},${boardDisplaySupervisor ? 'supervisor' : ''}`;
    var enterGroups = `${boardEnterGuest ? 'guest' : ''},${boardEnterUser ? 'user' : ''},${boardEnterDame ? 'dame' : ''},${boardEnterPartner ? 'partner' : ''},${boardEnterSubsupervisor ? 'subsupervisor' : ''},${boardEnterSupervisor ? 'supervisor' : ''}`;
    var writeGroups = `${boardWriteUser ? 'user' : ''},${boardWriteDame ? 'dame' : ''},${boardWritePartner ? 'partner' : ''},${boardWriteSubsupervisor ? 'subsupervisor' : ''},${boardWriteSupervisor ? 'supervisor' : ''}`;
    var commentGroups = `${boardCommentUser ? 'user' : ''},${boardCommentDame ? 'dame' : ''},${boardCommentPartner ? 'partner' : ''},${boardCommentSubsupervisor ? 'subsupervisor' : ''},${boardCommentSupervisor ? 'supervisor' : ''}`;

    var formData = new FormData();
    formData.append('board_id', board_id);
    formData.append('board_name', boardName);
    formData.append('board_type', boardType);
    formData.append('level_cut', boardLevel);
    formData.append('display_weight', boardWeight);
    formData.append('display_groups', displayGroups);
    formData.append('enter_groups', enterGroups);
    formData.append('write_groups', writeGroups);
    formData.append('comment_groups', commentGroups);

    // 수정 요청
    await fetch('{{supervisor_url}}/supervisor/post?board=y', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': csrftoken,
      },
    })
      .then(response => response.json())
      .then(async data => {
        console.log(data);
        if (data.result == 'success') {
          await showAlert('수정 성공', '게시판이 수정되었습니다.', 'success');
          location.reload();
        } else {
          await showAlert('수정 실패', '게시판 수정에 실패했습니다.', 'danger');
        }
      });
  }


</script>

{% endblock %}